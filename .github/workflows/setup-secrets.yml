name: Setup Repository Secrets

on:
  repository_dispatch:
    types: [setup-secrets]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: npm install libsodium-wrappers

      - name: Encrypt and add secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          AWS_ACCESS_KEY_ID: ${{ github.event.client_payload.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ github.event.client_payload.aws_secret_access_key }}
          AWS_REGION: ${{ github.event.client_payload.aws_region }}
        run: |
          # Encrypt AWS_ACCESS_KEY_ID
          ENCRYPTED_ACCESS_KEY=$(node -e "
          const sodium = require('libsodium-wrappers');
          (async () => {
            await sodium.ready;
            const binkey = sodium.from_base64('$PUBLIC_KEY', sodium.base64_variants.ORIGINAL);
            const binsec = sodium.from_string('$AWS_ACCESS_KEY_ID');
            const encBytes = sodium.crypto_box_seal(binsec, binkey);
            const output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL);
            console.log(output);
          })();
          ")
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_ACCESS_KEY_ID \
            -d "{\"encrypted_value\":\"$ENCRYPTED_ACCESS_KEY\",\"key_id\":\"$KEY_ID\"}"
          
          # Encrypt AWS_SECRET_ACCESS_KEY
          ENCRYPTED_SECRET_KEY=$(node -e "
          const sodium = require('libsodium-wrappers');
          (async () => {
            await sodium.ready;
            const binkey = sodium.from_base64('$PUBLIC_KEY', sodium.base64_variants.ORIGINAL);
            const binsec = sodium.from_string('$AWS_SECRET_ACCESS_KEY');
            const encBytes = sodium.crypto_box_seal(binsec, binkey);
            const output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL);
            console.log(output);
          })();
          ")
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_SECRET_ACCESS_KEY \
            -d "{\"encrypted_value\":\"$ENCRYPTED_SECRET_KEY\",\"key_id\":\"$KEY_ID\"}"
          
          # Encrypt AWS_REGION
          ENCRYPTED_REGION=$(node -e "
          const sodium = require('libsodium-wrappers');
          (async () => {
            await sodium.ready;
            const binkey = sodium.from_base64('$PUBLIC_KEY', sodium.base64_variants.ORIGINAL);
            const binsec = sodium.from_string('$AWS_REGION');
            const encBytes = sodium.crypto_box_seal(binsec, binkey);
            const output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL);
            console.log(output);
          })();
          ")
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_REGION \
            -d "{\"encrypted_value\":\"$ENCRYPTED_REGION\",\"key_id\":\"$KEY_ID\"}"
