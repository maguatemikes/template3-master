name: Setup Repository Secrets

on:
  repository_dispatch:
    types: [setup-secrets]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Dependencies
        run: npm install tweetnacl tweetnacl-util

      - name: Encrypt and Set AWS_ACCESS_KEY_ID
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          SECRET_VALUE: ${{ github.event.client_payload.aws_access_key_id }}
        run: |
          ENCRYPTED=$(node -e "
          const nacl = require('tweetnacl');
          const util = require('tweetnacl-util');
          const publicKey = util.decodeBase64(process.env.PUBLIC_KEY);
          const secretBytes = util.decodeUTF8(process.env.SECRET_VALUE);
          const encrypted = nacl.sealedbox.seal(secretBytes, publicKey);
          console.log(util.encodeBase64(encrypted));
          ")
          
          curl -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_ACCESS_KEY_ID" \
            -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}"

      - name: Encrypt and Set AWS_SECRET_ACCESS_KEY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          SECRET_VALUE: ${{ github.event.client_payload.aws_secret_access_key }}
        run: |
          ENCRYPTED=$(node -e "
          const nacl = require('tweetnacl');
          const util = require('tweetnacl-util');
          const publicKey = util.decodeBase64(process.env.PUBLIC_KEY);
          const secretBytes = util.decodeUTF8(process.env.SECRET_VALUE);
          const encrypted = nacl.sealedbox.seal(secretBytes, publicKey);
          console.log(util.encodeBase64(encrypted));
          ")
          
          curl -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_SECRET_ACCESS_KEY" \
            -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}"

      - name: Encrypt and Set AWS_REGION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          SECRET_VALUE: ${{ github.event.client_payload.aws_region }}
        run: |
          ENCRYPTED=$(node -e "
          const nacl = require('tweetnacl');
          const util = require('tweetnacl-util');
          const publicKey = util.decodeBase64(process.env.PUBLIC_KEY);
          const secretBytes = util.decodeUTF8(process.env.SECRET_VALUE);
          const encrypted = nacl.sealedbox.seal(secretBytes, publicKey);
          console.log(util.encodeBase64(encrypted));
          ")
          
          curl -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_REGION" \
            -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}"
