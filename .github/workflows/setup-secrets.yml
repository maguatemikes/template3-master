name: Setup AWS Secrets on Target Repo

on:
  repository_dispatch:
    types: [setup-secrets]

jobs:
  add-secrets-to-target:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Add AWS Secrets to Target Repository
        run: |
          pip install PyNaCl requests
          
          python3 << 'EOF'
          import os
          import requests
          import base64
          from nacl import encoding, public
          
          # Get target repo from payload
          TARGET_REPO = '${{ github.event.client_payload.target_repo }}'
          PUBLIC_KEY = '${{ github.event.client_payload.public_key }}'
          KEY_ID = '${{ github.event.client_payload.key_id }}'
          
          # GitHub API setup
          GITHUB_TOKEN = '${{ secrets.GH_PAT }}'
          
          headers = {
              'Authorization': f'token {GITHUB_TOKEN}',
              'Accept': 'application/vnd.github.v3+json'
          }
          
          # Encrypt secret function
          def encrypt_secret(secret_value, public_key):
              public_key_bytes = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
              sealed_box = public.SealedBox(public_key_bytes)
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(encrypted).decode("utf-8")
          
          # Secrets to add (from client_payload)
          secrets = {
              'AWS_ACCESS_KEY_ID': '${{ github.event.client_payload.aws_access_key_id }}',
              'AWS_SECRET_ACCESS_KEY': '${{ github.event.client_payload.aws_secret_access_key }}',
              'AWS_REGION': '${{ github.event.client_payload.aws_region }}'
          }
          
          print(f'ğŸ¯ Adding secrets to: {TARGET_REPO}')
          
          # Add each secret to TARGET repo
          for secret_name, secret_value in secrets.items():
              encrypted_value = encrypt_secret(secret_value, PUBLIC_KEY)
              
              secret_url = f'https://api.github.com/repos/{TARGET_REPO}/actions/secrets/{secret_name}'
              data = {
                  'encrypted_value': encrypted_value,
                  'key_id': KEY_ID
              }
              
              response = requests.put(secret_url, headers=headers, json=data)
              
              if response.status_code in [201, 204]:
                  print(f'âœ… Successfully added secret: {secret_name} to {TARGET_REPO}')
              else:
                  print(f'âŒ Failed to add secret {secret_name}: {response.status_code} - {response.text}')
          
          print(f'ğŸ‰ Finished adding secrets to {TARGET_REPO}')
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
