name: Setup Repository Secrets

on:
  repository_dispatch:
    types: [setup-secrets]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install PyNaCl
        run: pip install PyNaCl requests

      - name: Add secrets to target repo
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          AWS_ACCESS_KEY_ID: ${{ github.event.client_payload.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ github.event.client_payload.aws_secret_access_key }}
          AWS_REGION: ${{ github.event.client_payload.aws_region }}
        run: |
          python3 << 'EOF'
          import os
          import base64
          import requests
          from nacl import encoding, public

          def encrypt(public_key: str, secret_value: str) -> str:
              public_key_bytes = base64.b64decode(public_key)
              public_key_obj = public.PublicKey(public_key_bytes)
              sealed_box = public.SealedBox(public_key_obj)
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(encrypted).decode("utf-8")

          def add_secret(repo: str, token: str, key_id: str, secret_name: str, encrypted_value: str):
              url = f"https://api.github.com/repos/{repo}/actions/secrets/{secret_name}"
              headers = {
                  "Authorization": f"token {token}",
                  "Accept": "application/vnd.github+json"
              }
              data = {
                  "encrypted_value": encrypted_value,
                  "key_id": key_id
              }
              response = requests.put(url, headers=headers, json=data)
              print(f"{secret_name}: {response.status_code} - {response.text}")
              return response.status_code

          # Get environment variables
          target_repo = os.environ['TARGET_REPO']
          github_token = os.environ['GITHUB_TOKEN']
          public_key = os.environ['PUBLIC_KEY']
          key_id = os.environ['KEY_ID']
          aws_access_key = os.environ['AWS_ACCESS_KEY_ID']
          aws_secret_key = os.environ['AWS_SECRET_ACCESS_KEY']
          aws_region = os.environ['AWS_REGION']

          print(f"Adding secrets to {target_repo}")

          # Encrypt and add secrets
          encrypted_access_key = encrypt(public_key, aws_access_key)
          add_secret(target_repo, github_token, key_id, "AWS_ACCESS_KEY_ID", encrypted_access_key)

          encrypted_secret_key = encrypt(public_key, aws_secret_key)
          add_secret(target_repo, github_token, key_id, "AWS_SECRET_ACCESS_KEY", encrypted_secret_key)

          encrypted_region = encrypt(public_key, aws_region)
          add_secret(target_repo, github_token, key_id, "AWS_REGION", encrypted_region)

          print("Done!")
          EOF
