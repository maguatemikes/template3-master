name: Setup AWS Secrets

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  add-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Add AWS Secrets to Repository
        run: |
          pip install PyNaCl requests
          
          python3 << 'EOF'
          import os
          import requests
          import base64
          from nacl import encoding, public
          
          # GitHub API setup
          GITHUB_TOKEN = os.environ['GH_PAT']
          REPO_OWNER = os.environ['GITHUB_REPOSITORY'].split('/')[0]
          REPO_NAME = os.environ['GITHUB_REPOSITORY'].split('/')[1]
          
          headers = {
              'Authorization': f'token {GITHUB_TOKEN}',
              'Accept': 'application/vnd.github.v3+json'
          }
          
          # Get repository public key
          pub_key_url = f'https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/actions/secrets/public-key'
          pub_key_response = requests.get(pub_key_url, headers=headers)
          pub_key_data = pub_key_response.json()
          
          public_key = pub_key_data['key']
          key_id = pub_key_data['key_id']
          
          # Encrypt secret function
          def encrypt_secret(secret_value, public_key):
              public_key_bytes = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
              sealed_box = public.SealedBox(public_key_bytes)
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(encrypted).decode("utf-8")
          
          # Secrets to add
          secrets = {
              'AWS_ACCESS_KEY_ID': os.environ['AWS_ACCESS_KEY_ID'],
              'AWS_SECRET_ACCESS_KEY': os.environ['AWS_SECRET_ACCESS_KEY'],
              'AWS_REGION': os.environ['AWS_REGION']
          }
          
          # Add each secret
          for secret_name, secret_value in secrets.items():
              encrypted_value = encrypt_secret(secret_value, public_key)
              
              secret_url = f'https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/actions/secrets/{secret_name}'
              data = {
                  'encrypted_value': encrypted_value,
                  'key_id': key_id
              }
              
              response = requests.put(secret_url, headers=headers, json=data)
              
              if response.status_code in [201, 204]:
                  print(f'âœ… Successfully added secret: {secret_name}')
              else:
                  print(f'âŒ Failed to add secret {secret_name}: {response.text}')
          
          EOF
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
