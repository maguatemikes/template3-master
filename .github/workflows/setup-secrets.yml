name: Setup Repository Secrets

on:
  repository_dispatch:
    types: [setup-secrets]

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: npm install tweetnacl tweetnacl-util

      - name: Encrypt and add secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          PUBLIC_KEY: ${{ github.event.client_payload.public_key }}
          KEY_ID: ${{ github.event.client_payload.key_id }}
          AWS_ACCESS_KEY_ID: ${{ github.event.client_payload.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ github.event.client_payload.aws_secret_access_key }}
          AWS_REGION: ${{ github.event.client_payload.aws_region }}
        run: |
          # Encrypt AWS_ACCESS_KEY_ID
          ENCRYPTED_ACCESS_KEY=$(node -e "
          const nacl = require('tweetnacl');
          require('tweetnacl-util');
          const { decode } = require('tweetnacl-util');
          
          const publicKey = decode(Buffer.from('$PUBLIC_KEY', 'base64'));
          const secretBytes = Buffer.from('$AWS_ACCESS_KEY_ID');
          const encrypted = nacl.sealedbox.seal(secretBytes, publicKey);
          console.log(Buffer.from(encrypted).toString('base64'));
          ")
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_ACCESS_KEY_ID \
            -d "{\"encrypted_value\":\"$ENCRYPTED_ACCESS_KEY\",\"key_id\":\"$KEY_ID\"}"
          
          # Encrypt AWS_SECRET_ACCESS_KEY
          ENCRYPTED_SECRET_KEY=$(node -e "
          const nacl = require('tweetnacl');
          require('tweetnacl-util');
          const { decode } = require('tweetnacl-util');
          
          const publicKey = decode(Buffer.from('$PUBLIC_KEY', 'base64'));
          const secretBytes = Buffer.from('$AWS_SECRET_ACCESS_KEY');
          const encrypted = nacl.sealedbox.seal(secretBytes, publicKey);
          console.log(Buffer.from(encrypted).toString('base64'));
          ")
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_SECRET_ACCESS_KEY \
            -d "{\"encrypted_value\":\"$ENCRYPTED_SECRET_KEY\",\"key_id\":\"$KEY_ID\"}"
          
          # Add AWS_REGION (no encryption needed)
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$TARGET_REPO/actions/secrets/AWS_REGION \
            -d "{\"encrypted_value\":\"$AWS_REGION\",\"key_id\":\"$KEY_ID\"}"
